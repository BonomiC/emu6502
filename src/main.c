#include <stdio.h>
#include "cpu.h"

#define ADD_INSTRUCTION(...) add_instruction((uint8_t[]){__VA_ARGS__}, sizeof((uint8_t[]){__VA_ARGS__}))
#define ADD_PROGRAM(addr,...) add_program(addr, (uint8_t[]){__VA_ARGS__}, sizeof((uint8_t[]){__VA_ARGS__}))

void add_instruction(uint8_t *instructions, uint8_t size)
{
    static uint16_t ram_pos = 0x0600;
    memcpy(mainMemory + ram_pos, instructions, size);
    ram_pos += size;
    printf("RAM SIZE: %x\n", ram_pos);
}

void add_program(uint16_t addr, uint8_t *program, uint8_t size)
{
    memcpy(mainMemory + addr, program, size);
}

int main(int argc, char** argv)
{
    initialize();

    context.pc = 0x0600;

    // ADD_INSTRUCTION(0xA9, 27); // LDA #27

    // ADD_INSTRUCTION(0xAD, 0xCD, 0xAB); // LDA $ABCD

    // ADD_INSTRUCTION(0x69, 0xA); // ADC #10

    // ADD_INSTRUCTION(0xA2, 0x10); // LDX #10

    // ADD_INSTRUCTION(0x65, 0xBF); // ADC $BF

    // ADD_INSTRUCTION(0x75, 0xAF); // ADC $AF,X

    // ADD_INSTRUCTION(0x0A); // ASL

    // ADD_INSTRUCTION(0x06, 0xCD); // ASL $CD

    // ADD_INSTRUCTION(0xA4, 0xCD); // LDY $CD

    // ADD_INSTRUCTION(0x90, -6); // BCC -6 // Will cause loop prev 2 instructions until carry bit is set

    // mainMemory[0xABCD] = 195;
    // mainMemory[0x00BF] = 20;
    // mainMemory[0x00CD] = 17;

    // ADD_INSTRUCTION(
    //     0xA9,
    //     0x05,
    //     0xA2,
    //     0x03,
    //     0xA0,
    //     0x0F,
    //     0x69,
    //     0x07,
    //     0x29,
    //     0x0A,
    //     0x0A,
    //     0x90,
    //     0x02,
    //     0xA9,
    //     0xFF,
    //     0xA9,
    //     0x42); // Simple test made by chatgpt, ends with A=66, X=3, Y=15 (Decimal)

    // ADD_INSTRUCTION(0xA9, 0x00, 0xA2, 0xFF, 0xA0, 0x10,
    //     0xA9, 0x05, 0x69, 0x07,
    //     0x69, 0xF5,
    //     0x29, 0x03,
    //     0x29, 0x0E,
    //     0xA9, 0x20, 0x0A,
    //     0xA9, 0xC0, 0x0A,
    //     0xA9, 0x01, 0x90, 0x02, 0xA9, 0xFF, 0xA9, 0x11,
    //     0xA9, 0x80, 0x0A, 0x90, 0x02, 0xA9, 0x22,
    //     0xA2, 0x33, 0xA0, 0x44); // More advanced test made by chatgpt, ends with A=0x22, X=0x33, Y=0x44

    // ADD_INSTRUCTION(
    //     0xA9, 0x00, 0xA2, 0xAA, 0xA0, 0x55,
    //     0xA9, 0x05, 0x69, 0x07, 0xB0, 0x02, 0xA9, 0x11,
    //     0xA9, 0xF0, 0x69, 0x20, 0x90, 0x02, 0xA9, 0x22,
    //     0xA9, 0x20, 0x0A, 0xB0, 0x02, 0xA9, 0x33,
    //     0xA9, 0xC0, 0x0A, 0x90, 0x02, 0xA9, 0x44,
    //     0xA9, 0xFF, 0x29, 0x0F, 0x29, 0xF0
    // ); // ChatGPT again, post BCS test, ends with A=0x00, X=0xAA, Y=0x55

    // ADD_INSTRUCTION(
    //     0xA2, 0xFF, 0x9A,
    //     0xA9, 0x42, 0x48, 0xA9, 0x00, 0x68,
    //     0xA9, 0x55, 0x48, 0x68, 0x08, 0xA9, 0x11, 0x28,
    //     0xA2, 0xAA, 0x9A, 0xA2, 0x00, 0xBA
    // ); // ChatGPT Stack test, ends with A=0x11, X=0xAA, SP = 0xAA

    // Test for BRK & JMP - Works - Expected A=0x55, X=0xFF, SP=0xFF
    // /* $0600 program */
    // ADD_PROGRAM(0x0600, 0xA2, 0xFF, 0x9A, 0xA9, 0x42, 0x00);
    // /* $0620 handler */
    // ADD_PROGRAM(0x0620, 0x68, 0x68, 0x68, 0xA9, 0x55, 0x4C, 0x25, 0x06);
    // /* $FFFE vector */
    // ADD_PROGRAM(IRQ_HANDLER, 0x20, 0x06);

    // ADD_INSTRUCTION(
    //     0xA2, 0xFF, 0x9A,       /* LDX #$FF, TXS */
    //     0xA9, 0x50, 0xE9, 0x20, /* LDA #$50, SBC #$20 */
    //     0xA9, 0x10, 0xE9, 0x20, /* LDA #$10, SBC #$20 */
    //     0xA9, 0x80, 0xE9, 0x01  /* LDA #$80, SBC #$01 */
    // );

    // ADD_INSTRUCTION(0xA9, 0x50, 0xE9, 0x20); /* LDA #$50, SBC #$20 */

    ADD_INSTRUCTION(
        /* $0600 init + instruction tests */
        0xA2,0xFF,       // LDX #$FF
        0x9A,            // TXS
        0xA9,0x10,       // LDA #$10
        0xA0,0x20,       // LDY #$20
        0x69,0x05,       // ADC #$05
        0xE9,0x03,       // SBC #$03
        0x29,0x0F,       // AND #$0F
        0x09,0xF0,       // ORA #$F0
        0x49,0x0F,       // EOR #$0F
        0x24,0x00,       // BIT $00
        0x0A,0x4A,0x2A,0x6A, // ASL, LSR, ROL, ROR
        0x48,0x08,0x68,0x28,0xBA,0x9A, // PHA, PHP, PLA, PLP, TSX, TXS
        0x8D,0x00,0x20,  // STA $2000
        0x8E,0x01,0x20,  // STX $2001
        0x8C,0x02,0x20,  // STY $2002
        0x20,0x20,0x06,  // JSR $0620 â†’ subroutine

        /* $0620 subroutine */
        0xA9,0x99,       // LDA #$99
        0x60,            // RTS

        /* Infinite loop at $0623 */
        0x4C,0x23,0x06,  // JMP $0623

        /* BRK/IRQ vector immediately after */
        0x23,0x06        // Vector = $0623
    );

    printf("0x062B: %x\n", mainMemory[0x0623]);
    return 0;

    print_context();

    while (1)
    {
        step();
        print_context();
    }

    return 0;
}

